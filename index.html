<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>帰り道ワールド</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* 省略（元のCSSをそのまま使用） */
        /* 既存のスタイルコードをここに配置 */
        
        /* デバッグ用スタイル追加 */
        .debug-info {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 9999;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- 省略（元のHTMLをそのまま使用） -->
    <!-- 既存のHTMLコードをここに配置 -->
    
    <!-- デバッグ情報表示用 -->
    <div id="debug-info" class="debug-info" style="display:none;">
        <div id="debug-content"></div>
        <button onclick="clearDebug()" class="mt-2 bg-red-500 text-white px-2 py-1 rounded text-xs">Clear</button>
    </div>
    
    <script>
        // デバッグ関数
        function debug(message) {
            const debugInfo = document.getElementById('debug-info');
            const debugContent = document.getElementById('debug-content');
            debugInfo.style.display = 'block';
            debugContent.innerHTML += message + '<br>';
        }
        
        function clearDebug() {
            document.getElementById('debug-content').innerHTML = '';
        }
        
        // グローバル変数を定義
        let currentPerspective = 'ritsu';
        let deleteTarget = null;
        
        // 安全にローカルストレージを使用するヘルパー関数
        function safeGetItem(key, defaultValue) {
            try {
                const value = localStorage.getItem(key);
                return value ? JSON.parse(value) : defaultValue;
            } catch (e) {
                debug('ローカルストレージの読み込みエラー: ' + e.message);
                return defaultValue;
            }
        }
        
        function safeSetItem(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
                return true;
            } catch (e) {
                debug('ローカルストレージの保存エラー: ' + e.message);
                return false;
            }
        }
        
        // 初期化関数
        function initializeStorage() {
            debug('ストレージを初期化しています...');
            if (!safeGetItem('kaerimichiPosts', null)) {
                safeSetItem('kaerimichiPosts', {});
                debug('投稿データを初期化しました');
            }
            
            if (!safeGetItem('kaerimichiProgress', null)) {
                safeSetItem('kaerimichiProgress', {
                    'hill': 0,
                    'forest': 0,
                    'sea': 0,
                    'river': 0,
                    'cave': 0,
                    'plain': 0 // 人物の平原を追加
                });
                debug('進捗データを初期化しました');
            }
        }
        
        // 元のJavaScriptコードを修正して使用
        // Modal関連の関数
        function openModal(modal) {
            debug('モーダルを開きます: ' + modal);
            try {
                const modalElement = document.getElementById(modal + '-modal');
                if (modalElement) {
                    modalElement.style.display = 'block';
                    
                    // 投稿を読み込む
                    if (modal === 'allposts') {
                        loadAllPosts();
                    } else {
                        loadPosts(modal + '-ritsu');
                        loadPosts(modal + '-shuya');
                    }
                } else {
                    debug('モーダル要素が見つかりません: ' + modal + '-modal');
                }
            } catch (e) {
                debug('モーダルを開く際のエラー: ' + e.message);
            }
        }
        
        function closeModal(modal) {
            debug('モーダルを閉じます: ' + modal);
            try {
                const modalElement = document.getElementById(modal + '-modal');
                if (modalElement) {
                    modalElement.style.display = 'none';
                } else {
                    debug('モーダル要素が見つかりません: ' + modal + '-modal');
                }
            } catch (e) {
                debug('モーダルを閉じる際のエラー: ' + e.message);
            }
        }
        
        // タブ切替関数
        function switchTab(perspective) {
            debug('タブを切り替えます: ' + perspective);
            currentPerspective = perspective;
            document.getElementById('tab-ritsu').classList.remove('active');
            document.getElementById('tab-shuya').classList.remove('active');
            document.getElementById('tab-' + perspective).classList.add('active');
        }
        
        // ストーリータブ切替関数
        function switchStoryTab(perspective) {
            debug('ストーリータブを切り替えます: ' + perspective);
            document.getElementById('story-tab-ritsu').classList.remove('active');
            document.getElementById('story-tab-shuya').classList.remove('active');
            document.getElementById('story-tab-' + perspective).classList.add('active');
            
            document.getElementById('story-content-ritsu').style.display = 'none';
            document.getElementById('story-content-shuya').style.display = 'none';
            document.getElementById('story-content-' + perspective).style.display = 'block';
        }
        
        // モーダルタブ切替関数
        function switchModalTab(modal, perspective) {
            debug('モーダルタブを切り替えます: ' + modal + ', ' + perspective);
            document.getElementById(modal + '-tab-ritsu').classList.remove('active');
            document.getElementById(modal + '-tab-shuya').classList.remove('active');
            document.getElementById(modal + '-tab-' + perspective).classList.add('active');
            
            document.getElementById(modal + '-content-ritsu').style.display = 'none';
            document.getElementById(modal + '-content-shuya').style.display = 'none';
            document.getElementById(modal + '-content-' + perspective).style.display = 'block';
        }
        
        // ヒント表示関数
        function showHint(id) {
            debug('ヒントを表示します: ' + id);
            document.getElementById(id + '-hint').style.display = 'block';
            document.getElementById(id + '-hint-btn').style.display = 'none';
        }
        
        function showDetailHint(id) {
            debug('詳細ヒントを表示します: ' + id);
            document.getElementById(id + '-detail-hint').style.display = 'block';
        }
        
        // 投稿関連の関数
        function addPost(id) {
            debug('投稿を追加します: ' + id);
            const title = document.getElementById(id + '-post-title').value.trim();
            const content = document.getElementById(id + '-post-content').value.trim();
            
            if (!title || !content) {
                alert('タイトルと内容を入力してください');
                return;
            }
            
            const now = new Date();
            const post = {
                id: Date.now(),
                title: title,
                content: content,
                date: now.toLocaleDateString() + ' ' + now.toLocaleTimeString(),
                likes: 0
            };
            
            // Get existing posts from localStorage
            const posts = safeGetItem('kaerimichiPosts', {});
            if (!posts[id]) {
                posts[id] = [];
            }
            
            posts[id].unshift(post);
            safeSetItem('kaerimichiPosts', posts);
            
            // Clear form
            document.getElementById(id + '-post-title').value = '';
            document.getElementById(id + '-post-content').value = '';
            
            // Reload posts
            loadPosts(id);
        }
        
        // 投稿読み込み関数
        function loadPosts(id) {
            debug('投稿を読み込みます: ' + id);
            const postsContainer = document.getElementById(id + '-posts');
            if (!postsContainer) {
                debug('投稿コンテナが見つかりません: ' + id + '-posts');
                return;
            }
            
            const posts = safeGetItem('kaerimichiPosts', {})[id] || [];
            
            let html = '';
            if (posts.length === 0) {
                html = '<p class="text-gray-500">まだ投稿がありません</p>';
            } else {
                posts.forEach(post => {
                    html += `
                    <div class="post" id="post-${post.id}">
                        <div class="post-title">${post.title}</div>
                        <div class="post-content">${post.content}</div>
                        <div class="post-controls">
                            <span>${post.date}</span>
                            <div>
                                <span class="like-btn" onclick="likePost('${id}', ${post.id})">👍 ${post.likes}</span>
                                <span class="delete-btn ml-3" onclick="deletePost('${id}', ${post.id})">🗑️ 削除</span>
                            </div>
                        </div>
                    </div>
                    `;
                });
            }
            
            postsContainer.innerHTML = html;
        }
        
        // 全投稿の読み込み（投稿一覧ページ用）
        function loadAllPosts() {
            debug('全ての投稿を読み込みます');
            const postsContainer = document.getElementById('all-posts-container');
            if (!postsContainer) {
                debug('全投稿コンテナが見つかりません');
                return;
            }
            
            const allPosts = safeGetItem('kaerimichiPosts', {});
            const sectionNames = {
                'hill-ritsu': '物語の丘（律）',
                'hill-shuya': '物語の丘（周也）',
                'forest-ritsu': '心情の森（律）',
                'forest-shuya': '心情の森（周也）',
                'sea-ritsu': '問いの海（律）',
                'sea-shuya': '問いの海（周也）',
                'river-ritsu': '表現の川（律）',
                'river-shuya': '表現の川（周也）',
                'cave-ritsu': '構造の洞窟（律）',
                'cave-shuya': '構造の洞窟（周也）',
                'plain-ritsu': '人物の平原（律）',
                'plain-shuya': '人物の平原（周也）',
                'story-ritsu': '本文（律）',
                'story-shuya': '本文（周也）'
            };
            
            let html = '';
            let totalPosts = 0;
            
            // フィルターボタン
            html += `
            <div class="mb-4 flex flex-wrap">
                <button class="filter-btn active bg-gray-200 hover:bg-gray-300" data-filter="all">すべて</button>
                <button class="filter-btn bg-gray-200 hover:bg-gray-300" data-filter="story">本文</button>
                <button class="filter-btn bg-gray-200 hover:bg-gray-300" data-filter="hill">物語の丘</button>
                <button class="filter-btn bg-gray-200 hover:bg-gray-300" data-filter="forest">心情の森</button>
                <button class="filter-btn bg-gray-200 hover:bg-gray-300" data-filter="sea">問いの海</button>
                <button class="filter-btn bg-gray-200 hover:bg-gray-300" data-filter="river">表現の川</button>
                <button class="filter-btn bg-gray-200 hover:bg-gray-300" data-filter="cave">構造の洞窟</button>
                <button class="filter-btn bg-gray-200 hover:bg-gray-300" data-filter="plain">人物の平原</button>
                <button class="filter-btn bg-gray-200 hover:bg-gray-300" data-filter="ritsu">律の視点</button>
                <button class="filter-btn bg-gray-200 hover:bg-gray-300" data-filter="shuya">周也の視点</button>
            </div>
            `;
            
            // 各セクションの投稿を処理
            Object.keys(allPosts).forEach(section => {
                if (allPosts[section] && allPosts[section].length > 0) {
                    const posts = allPosts[section];
                    totalPosts += posts.length;
                    
                    posts.forEach(post => {
                        const sectionName = sectionNames[section] || section;
                        // 必要なフィルタークラスを追加
                        const filterClasses = section.split('-').join(' ');
                        
                        html += `
                        <div class="post post-item ${filterClasses}" id="allpost-${post.id}">
                            <div class="post-location">${sectionName}</div>
                            <div class="post-title">${post.title}</div>
                            <div class="post-content">${post.content}</div>
                            <div class="post-controls">
                                <span>${post.date}</span>
                                <div>
                                    <span class="like-btn" onclick="likePost('${section}', ${post.id}, true)">👍 ${post.likes}</span>
                                </div>
                            </div>
                        </div>
                        `;
                    });
                }
            });
            
            if (totalPosts === 0) {
                html = '<p class="text-gray-500">まだ投稿がありません</p>';
            }
            
            postsContainer.innerHTML = html;
            
            // フィルターボタンのイベントハンドラを設定
            document.querySelectorAll('.filter-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const filter = this.getAttribute('data-filter');
                    
                    // ボタンの見た目を更新
                    document.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('active', 'bg-green-500', 'text-white');
                        btn.classList.add('bg-gray-200');
                    });
                    this.classList.add('active', 'bg-green-500', 'text-white');
                    this.classList.remove('bg-gray-200');
                    
                    // 投稿を表示/非表示
                    document.querySelectorAll('.post-item').forEach(post => {
                        if (filter === 'all') {
                            post.style.display = 'block';
                        } else {
                            if (post.classList.contains(filter)) {
                                post.style.display = 'block';
                            } else {
                                post.style.display = 'none';
                            }
                        }
                    });
                });
            });
        }
        
        // いいね機能
        function likePost(section, postId, reload = false) {
            debug('いいねします: ' + section + ', ' + postId);
            const posts = safeGetItem('kaerimichiPosts', {});
            const sectionPosts = posts[section] || [];
            
            const postIndex = sectionPosts.findIndex(p => p.id === postId);
            if (postIndex !== -1) {
                sectionPosts[postIndex].likes++;
                posts[section] = sectionPosts;
                safeSetItem('kaerimichiPosts', posts);
                
                if (reload) {
                    loadAllPosts();
                } else {
                    loadPosts(section);
                }
            }
        }
        
        // 削除機能
        function deletePost(section, postId) {
            debug('削除します: ' + section + ', ' + postId);
            deleteTarget = { section, postId };
            document.getElementById('delete-modal').style.display = 'flex';
            document.getElementById('admin-password').focus();
            document.getElementById('password-error').style.display = 'none';
        }
        
        function cancelDelete() {
            debug('削除をキャンセルします');
            deleteTarget = null;
            document.getElementById('delete-modal').style.display = 'none';
            document.getElementById('admin-password').value = '';
        }
        
        function confirmDelete() {
            debug('削除を確認します');
            const password = document.getElementById('admin-password').value;
            
            if (password === 'admin') {
                if (deleteTarget) {
                    const { section, postId } = deleteTarget;
                    const posts = safeGetItem('kaerimichiPosts', {});
                    const sectionPosts = posts[section] || [];
                    
                    const newPosts = sectionPosts.filter(p => p.id !== postId);
                    posts[section] = newPosts;
                    safeSetItem('kaerimichiPosts', posts);
                    
                    // Close modal and reload posts
                    document.getElementById('delete-modal').style.display = 'none';
                    document.getElementById('admin-password').value = '';
                    loadPosts(section);
                }
            } else {
                document.getElementById('password-error').style.display = 'block';
            }
        }
        
        // 進捗管理関連の関数
        function updateProgress(point) {
            debug('進捗を更新します: ' + point);
            const progress = safeGetItem('kaerimichiProgress', {});
            
            // Count checked checkboxes
            let checkedCount = 0;
            if (document.getElementById(point + '-ritsu-check1') && document.getElementById(point + '-ritsu-check1').checked) checkedCount++;
            if (document.getElementById(point + '-ritsu-check2') && document.getElementById(point + '-ritsu-check2').checked) checkedCount++;
            if (document.getElementById(point + '-shuya-check1') && document.getElementById(point + '-shuya-check1').checked) checkedCount++;
            if (document.getElementById(point + '-shuya-check2') && document.getElementById(point + '-shuya-check2').checked) checkedCount++;
            
            // Calculate percentage (4 total checkboxes per point)
            const percentage = Math.round((checkedCount / 4) * 100);
            progress[point] = percentage;
            
            // Update localStorage
            safeSetItem('kaerimichiProgress', progress);
            
            // Update UI
            updatePointProgress(point, percentage);
            updateOverallProgress();
        }
        
        function updatePointProgress(point, percentage) {
            debug('ポイントの進捗を更新します: ' + point + ', ' + percentage + '%');
            // Update progress badge on map
            const pointElements = document.querySelectorAll('.' + point + ' .progress-badge');
            pointElements.forEach(el => {
                el.textContent = percentage + '%';
            });
        }
        
        function updateOverallProgress() {
            debug('全体の進捗を更新します');
            const progress = safeGetItem('kaerimichiProgress', {});
            const points = Object.keys(progress);
            
            let total = 0;
            points.forEach(point => {
                total += progress[point];
            });
            
            const overallPercentage = Math.round(total / points.length);
            
            // Update progress bar and text
            const progressBar = document.getElementById('overall-progress');
            const progressText = document.getElementById('overall-progress-text');
            
            if (progressBar && progressText) {
                progressBar.style.width = overallPercentage + '%';
                progressText.textContent = overallPercentage + '%';
            } else {
                debug('進捗バーまたはテキスト要素が見つかりません');
            }
        }
        
        function updateAllProgress() {
            debug('すべての進捗を更新します');
            const progress = safeGetItem('kaerimichiProgress', {});
            
            // Set checkbox states based on progress
            Object.keys(progress).forEach(point => {
                updatePointProgress(point, progress[point]);
                
                // Calculate how many checkboxes should be checked
                const checksToCheck = Math.round((progress[point] / 100) * 4);
                let checksChecked = 0;
                
                // Check checkboxes in order if they exist
                if (checksChecked < checksToCheck && document.getElementById(point + '-ritsu-check1')) {
                    document.getElementById(point + '-ritsu-check1').checked = true;
                    checksChecked++;
                }
                
                if (checksChecked < checksToCheck && document.getElementById(point + '-ritsu-check2')) {
                    document.getElementById(point + '-ritsu-check2').checked = true;
                    checksChecked++;
                }
                
                if (checksChecked < checksToCheck && document.getElementById(point + '-shuya-check1')) {
                    document.getElementById(point + '-shuya-check1').checked = true;
                    checksChecked++;
                }
                
                if (checksChecked < checksToCheck && document.getElementById(point + '-shuya-check2')) {
                    document.getElementById(point + '-shuya-check2').checked = true;
                    checksChecked++;
                }
            });
            
            updateOverallProgress();
        }
        
        // ドキュメント読み込み完了時の処理
        document.addEventListener('DOMContentLoaded', function() {
            debug('ページを初期化しています...');
            try {
                // ローカルストレージの初期化
                initializeStorage();
                
                // 投稿と進捗の読み込み
                loadAllPosts();
                updateAllProgress();
                
                debug('初期化完了');
            } catch (e) {
                debug('初期化エラー: ' + e.message);
            }
        });
    </script>
</body>
</html>
